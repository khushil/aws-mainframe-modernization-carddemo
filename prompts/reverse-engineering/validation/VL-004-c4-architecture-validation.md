# VL-004: C4 Architecture Validation

## Prompt

```xml
<context>
  <project>CardDemo - AWS mainframe credit card processing demonstration application</project>

  <role>
    <persona>Validation Analyst specializing in C4 architecture model verification</persona>

    <validation_expertise>
      <skill>C4 model validation: verifying correct abstraction at each level (Context, Container, Component, Code)</skill>
      <skill>Mermaid C4 diagram syntax validation: ensuring diagrams render correctly and use proper C4 elements</skill>
      <skill>Mainframe architecture verification: confirming CICS regions, batch subsystems, VSAM files are correctly characterized</skill>
      <skill>Program inventory cross-referencing: verifying every listed program exists in the source tree</skill>
      <skill>Code pattern verification: confirming documented patterns match actual implementation in source files</skill>
      <skill>Source citation auditing: reading cited file:line references and confirming quoted code matches</skill>
      <skill>Architectural pattern cataloging: ensuring all significant patterns are documented with accurate examples</skill>
      <skill>Container-component mapping validation: confirming programs are assigned to correct containers and functional groups</skill>
      <skill>Integration point verification: confirming extension directories and optional components are accurately described</skill>
      <skill>Completeness analysis: ensuring all 31 programs, 30 copybooks, and 17 BMS mapsets are accounted for</skill>
    </validation_expertise>

    <carddemo_context>
      CardDemo's C4 architecture documentation (RE-004 output) should describe:

      Level 1 (System Context):
      - CardDemo as the central system
      - 4 actor types: Card Holder, Customer Service Rep, System Administrator, Batch Operator
      - External systems (optional): Card Network, Core Banking, Statement Printing

      Level 2 (Containers):
      - CICS Online Region: Hosts 19 online programs (CO* prefix + CSUTLDTC utility)
      - Batch Subsystem: Hosts 12 batch programs (CB* prefix)
      - BMS Presentation: 17 mapsets (NOT 21)
      - VSAM Data Store: 6 KSDS files (ACCTDAT, CARDDAT, CUSTDAT, TRANSACT, CCXREF, USRSEC)
      - Optional: DB2 Database, IMS Database, MQ Messaging (in 3 extension directories)

      Level 3 (Components):
      - 31 COBOL programs (NOT 39) grouped into functional component groups
      - 19 online programs within CICS Online Region
      - 12 batch programs within Batch Subsystem
      - Component interactions via XCTL, LINK, COMMAREA

      Level 4 (Code):
      - 7+ recurring implementation patterns with verified code examples
      - Pseudo-conversational pattern, screen-program coupling, VSAM CRUD, error handling, etc.
      - Algorithm documentation (interest calculation, payment validation)
    </carddemo_context>

    <mindset>
      Validate the C4 architecture documentation with extreme rigor. Every program listed must exist in
      app/cbl/. Every code pattern excerpt must be verifiable at the cited source location. Every container
      and component relationship must accurately reflect how the CardDemo system actually works. The
      documentation must correctly distinguish between the 19 online and 12 batch programs, use the correct
      count of 31 total programs (not 39), and correctly state 17 BMS mapsets (not 21). C4 level
      boundaries must be respected—no implementation details at the wrong abstraction level.
    </mindset>
  </role>

  <objective>
    <primary_goal>
      Validate the C4 architecture documentation generated by RE-004 against the actual CardDemo source
      code. Verify program inventories, container mappings, component groupings, code pattern excerpts,
      diagram accuracy, and completeness across all four C4 levels.
    </primary_goal>

    <validation_scope>
      <target_directory>docs/reverse-engineering/04-architecture/</target_directory>
      <target_files>
        <file>C4-L1-SYSTEM-CONTEXT.md</file>
        <file>C4-L2-CONTAINER.md</file>
        <file>C4-L3-COMPONENT.md</file>
        <file>C4-L4-CODE-PATTERNS.md</file>
        <file>diagrams/system-context.md</file>
        <file>diagrams/container.md</file>
        <file>diagrams/component.md</file>
      </target_files>
    </validation_scope>

    <success_criteria>
      <criterion>Program count verified as exactly 31 (NOT 39)</criterion>
      <criterion>BMS mapset count verified as exactly 17 (NOT 21)</criterion>
      <criterion>Every listed program confirmed to exist in app/cbl/</criterion>
      <criterion>Every code pattern excerpt verified at cited file:line location</criterion>
      <criterion>L1 system context actors and external systems correctly identified</criterion>
      <criterion>L2 containers accurately map CICS region, VSAM files, batch subsystem</criterion>
      <criterion>L3 components correctly classify all 31 programs into functional groups</criterion>
      <criterion>L4 code patterns include pseudo-conversational, VSAM I/O, COMMAREA verified against source</criterion>
      <criterion>3 extension directories correctly described as optional</criterion>
      <criterion>7+ architectural patterns documented with accurate examples</criterion>
      <criterion>All Mermaid C4 diagrams use valid syntax</criterion>
      <criterion>No hallucinated programs, copybooks, or file references</criterion>
    </success_criteria>
  </objective>

  <codebase_location>/home/ubuntu/src/aws-mainframe-modernization-carddemo</codebase_location>
</context>

<ground_truth>
  <description>
    Canonical inventory verified directly from the source tree. These counts and file lists are the
    authoritative reference for all validation checks. Any deviation in the RE-004 documentation
    from these values constitutes a finding.
  </description>

  <programs total="31">
    <online_programs count="19">
      <program file="COACTUPC.cbl" function="Account Update" container="CICS Online"/>
      <program file="COACTVWC.cbl" function="Account View" container="CICS Online"/>
      <program file="COADM01C.cbl" function="Admin Menu" container="CICS Online"/>
      <program file="COBIL00C.cbl" function="Bill Payment" container="CICS Online"/>
      <program file="COBSWAIT.cbl" function="Batch Wait Utility" container="CICS Online"/>
      <program file="COCRDLIC.cbl" function="Card List" container="CICS Online"/>
      <program file="COCRDSLC.cbl" function="Card Search" container="CICS Online"/>
      <program file="COCRDUPC.cbl" function="Card Update" container="CICS Online"/>
      <program file="COMEN01C.cbl" function="Main Menu" container="CICS Online"/>
      <program file="CORPT00C.cbl" function="Report Generation" container="CICS Online"/>
      <program file="COSGN00C.cbl" function="Sign-On" container="CICS Online"/>
      <program file="COTRN00C.cbl" function="Transaction Menu" container="CICS Online"/>
      <program file="COTRN01C.cbl" function="Transaction List" container="CICS Online"/>
      <program file="COTRN02C.cbl" function="Transaction Detail" container="CICS Online"/>
      <program file="COUSR00C.cbl" function="User Menu" container="CICS Online"/>
      <program file="COUSR01C.cbl" function="User Add" container="CICS Online"/>
      <program file="COUSR02C.cbl" function="User Update" container="CICS Online"/>
      <program file="COUSR03C.cbl" function="User Delete" container="CICS Online"/>
      <program file="CSUTLDTC.cbl" function="Date Utility" container="CICS Online"/>
    </online_programs>
    <batch_programs count="12">
      <program file="CBACT01C.cbl" function="Account File Create" container="Batch Subsystem"/>
      <program file="CBACT02C.cbl" function="Account File Update" container="Batch Subsystem"/>
      <program file="CBACT03C.cbl" function="Account File Delete" container="Batch Subsystem"/>
      <program file="CBACT04C.cbl" function="Account File Report" container="Batch Subsystem"/>
      <program file="CBCUS01C.cbl" function="Customer Maintenance" container="Batch Subsystem"/>
      <program file="CBEXPORT.cbl" function="Data Export" container="Batch Subsystem"/>
      <program file="CBIMPORT.cbl" function="Data Import" container="Batch Subsystem"/>
      <program file="CBSTM03A.CBL" function="Statement Processing A" container="Batch Subsystem"/>
      <program file="CBSTM03B.CBL" function="Statement Processing B" container="Batch Subsystem"/>
      <program file="CBTRN01C.cbl" function="Transaction Posting" container="Batch Subsystem"/>
      <program file="CBTRN02C.cbl" function="Interest Calculation" container="Batch Subsystem"/>
      <program file="CBTRN03C.cbl" function="Statement Generation" container="Batch Subsystem"/>
    </batch_programs>
  </programs>

  <copybooks total="30">
    <copybook file="COADM02Y.cpy" purpose="Admin screen data"/>
    <copybook file="COCOM01Y.cpy" purpose="Common communication area (COMMAREA)"/>
    <copybook file="CODATECN.cpy" purpose="Date conversion routines"/>
    <copybook file="COMEN02Y.cpy" purpose="Menu screen data"/>
    <copybook file="COSTM01.CPY" purpose="Statement processing data"/>
    <copybook file="COTTL01Y.cpy" purpose="Title/header data"/>
    <copybook file="CSDAT01Y.cpy" purpose="Date formatting"/>
    <copybook file="CSLKPCDY.cpy" purpose="Lookup code data"/>
    <copybook file="CSMSG01Y.cpy" purpose="Message area 01"/>
    <copybook file="CSMSG02Y.cpy" purpose="Message area 02"/>
    <copybook file="CSSETATY.cpy" purpose="Set attribute utility"/>
    <copybook file="CSSTRPFY.cpy" purpose="String processing"/>
    <copybook file="CSUSR01Y.cpy" purpose="User security record"/>
    <copybook file="CSUTLDPY.cpy" purpose="Date utility parameters"/>
    <copybook file="CSUTLDWY.cpy" purpose="Date utility working storage"/>
    <copybook file="CUSTREC.cpy" purpose="Customer record layout"/>
    <copybook file="CVACT01Y.cpy" purpose="Account record layout"/>
    <copybook file="CVACT02Y.cpy" purpose="Account record alternate"/>
    <copybook file="CVACT03Y.cpy" purpose="Account record extended"/>
    <copybook file="CVCRD01Y.cpy" purpose="Card record layout"/>
    <copybook file="CVCUS01Y.cpy" purpose="Customer VSAM record"/>
    <copybook file="CVEXPORT.cpy" purpose="Export record layout"/>
    <copybook file="CVTRA01Y.cpy" purpose="Transaction record layout"/>
    <copybook file="CVTRA02Y.cpy" purpose="Transaction record alternate"/>
    <copybook file="CVTRA03Y.cpy" purpose="Transaction record extended"/>
    <copybook file="CVTRA04Y.cpy" purpose="Transaction record type 4"/>
    <copybook file="CVTRA05Y.cpy" purpose="Transaction record type 5"/>
    <copybook file="CVTRA06Y.cpy" purpose="Transaction record type 6"/>
    <copybook file="CVTRA07Y.cpy" purpose="Transaction record type 7"/>
    <copybook file="UNUSED1Y.cpy" purpose="Unused/reserved copybook"/>
  </copybooks>

  <bms_mapsets total="17">
    <mapset file="COACTUP.bms" screen="Account Update"/>
    <mapset file="COACTVW.bms" screen="Account View"/>
    <mapset file="COADM01.bms" screen="Admin Menu"/>
    <mapset file="COBIL00.bms" screen="Bill Payment"/>
    <mapset file="COCRDLI.bms" screen="Card List"/>
    <mapset file="COCRDSL.bms" screen="Card Search"/>
    <mapset file="COCRDUP.bms" screen="Card Update"/>
    <mapset file="COMEN01.bms" screen="Main Menu"/>
    <mapset file="CORPT00.bms" screen="Report"/>
    <mapset file="COSGN00.bms" screen="Sign-On"/>
    <mapset file="COTRN00.bms" screen="Transaction Menu"/>
    <mapset file="COTRN01.bms" screen="Transaction List"/>
    <mapset file="COTRN02.bms" screen="Transaction Detail"/>
    <mapset file="COUSR00.bms" screen="User Menu"/>
    <mapset file="COUSR01.bms" screen="User Add"/>
    <mapset file="COUSR02.bms" screen="User Update"/>
    <mapset file="COUSR03.bms" screen="User Delete"/>
  </bms_mapsets>

  <bms_copybooks total="17">
    <copybook file="COACTUP.CPY"/>
    <copybook file="COACTVW.CPY"/>
    <copybook file="COADM01.CPY"/>
    <copybook file="COBIL00.CPY"/>
    <copybook file="COCRDLI.CPY"/>
    <copybook file="COCRDSL.CPY"/>
    <copybook file="COCRDUP.CPY"/>
    <copybook file="COMEN01.CPY"/>
    <copybook file="CORPT00.CPY"/>
    <copybook file="COSGN00.CPY"/>
    <copybook file="COTRN00.CPY"/>
    <copybook file="COTRN01.CPY"/>
    <copybook file="COTRN02.CPY"/>
    <copybook file="COUSR00.CPY"/>
    <copybook file="COUSR01.CPY"/>
    <copybook file="COUSR02.CPY"/>
    <copybook file="COUSR03.CPY"/>
  </bms_copybooks>

  <jcl_files total="38">
    <file>ACCTFILE.jcl</file>
    <file>CARDFILE.jcl</file>
    <file>CBADMCDJ.jcl</file>
    <file>CBEXPORT.jcl</file>
    <file>CBIMPORT.jcl</file>
    <file>CLOSEFIL.jcl</file>
    <file>COMBTRAN.jcl</file>
    <file>CREASTMT.JCL</file>
    <file>CUSTFILE.jcl</file>
    <file>DALYREJS.jcl</file>
    <file>DEFCUST.jcl</file>
    <file>DEFGDGB.jcl</file>
    <file>DEFGDGD.jcl</file>
    <file>DISCGRP.jcl</file>
    <file>DUSRSECJ.jcl</file>
    <file>ESDSRRDS.jcl</file>
    <file>FTPJCL.JCL</file>
    <file>INTCALC.jcl</file>
    <file>INTRDRJ1.JCL</file>
    <file>INTRDRJ2.JCL</file>
    <file>OPENFIL.jcl</file>
    <file>POSTTRAN.jcl</file>
    <file>PRTCATBL.jcl</file>
    <file>READACCT.jcl</file>
    <file>READCARD.jcl</file>
    <file>READCUST.jcl</file>
    <file>READXREF.jcl</file>
    <file>REPTFILE.jcl</file>
    <file>TCATBALF.jcl</file>
    <file>TRANBKP.jcl</file>
    <file>TRANCATG.jcl</file>
    <file>TRANFILE.jcl</file>
    <file>TRANIDX.jcl</file>
    <file>TRANREPT.jcl</file>
    <file>TRANTYPE.jcl</file>
    <file>TXT2PDF1.JCL</file>
    <file>WAITSTEP.jcl</file>
    <file>XREFFILE.jcl</file>
  </jcl_files>

  <extension_directories count="3">
    <directory path="app/app-authorization-ims-db2-mq/" description="Authorization processing with IMS, DB2, and MQ"/>
    <directory path="app/app-transaction-type-db2/" description="Transaction type management with DB2"/>
    <directory path="app/app-vsam-mq/" description="Account extraction with MQ messaging"/>
  </extension_directories>

  <vsam_files count="6">
    <file name="ACCTDAT" type="KSDS" key="Account ID" description="Account master file"/>
    <file name="CARDDAT" type="KSDS" key="Card number" description="Card master file"/>
    <file name="CUSTDAT" type="KSDS" key="Customer ID" description="Customer master file"/>
    <file name="TRANSACT" type="KSDS" key="Transaction ID" description="Daily transaction log"/>
    <file name="CCXREF" type="KSDS" key="Card-Account cross-reference" description="Card-to-account cross-reference"/>
    <file name="USRSEC" type="KSDS" key="User ID" description="User security file"/>
  </vsam_files>

  <architectural_patterns minimum="7">
    <pattern name="Pseudo-Conversational" description="EIBCALEN check, COMMAREA state, RETURN TRANSID"/>
    <pattern name="Screen-Program Coupling" description="BMS SEND MAP / RECEIVE MAP with symbolic copybook"/>
    <pattern name="VSAM CRUD Operations" description="READ, WRITE, REWRITE, DELETE via EXEC CICS FILE or COBOL I/O"/>
    <pattern name="Error Handling" description="RESP/RESP2 checking, file status codes, error message population"/>
    <pattern name="Input Validation" description="Numeric validation, required field checks, date validation"/>
    <pattern name="Menu Navigation" description="EVALUATE on selection, XCTL to target program"/>
    <pattern name="Batch Sequential Processing" description="OPEN, READ loop with AT END, process, WRITE, CLOSE"/>
  </architectural_patterns>

  <known_hallucinations>
    <hallucination id="1">
      <claim>CVCAR00Y.cpy referenced as card copybook</claim>
      <reality>Actual file is CVCRD01Y.cpy — no file named CVCAR00Y.cpy exists</reality>
      <severity>Critical</severity>
    </hallucination>
    <hallucination id="2">
      <claim>COUSR00Y.cpy referenced as user copybook</claim>
      <reality>Actual file is CSUSR01Y.cpy — no file named COUSR00Y.cpy exists</reality>
      <severity>Critical</severity>
    </hallucination>
    <hallucination id="3">
      <claim>S9(7)V99 COMP-3 cited for monetary fields</claim>
      <reality>Actual PIC is S9(10)V99 (see CVACT01Y.cpy line 7)</reality>
      <severity>Critical</severity>
    </hallucination>
    <hallucination id="4">
      <claim>39 COBOL programs</claim>
      <reality>Actual count is 31 programs (19 online + 12 batch)</reality>
      <severity>Critical</severity>
    </hallucination>
    <hallucination id="5">
      <claim>21 BMS mapsets</claim>
      <reality>Actual count is 17 BMS mapsets in app/bms/</reality>
      <severity>Critical</severity>
    </hallucination>
  </known_hallucinations>
</ground_truth>

<validation_methodology>
  <phase name="Phase 1: File Existence and Inventory Verification">
    <description>Verify all target documentation files exist and confirm asset counts</description>
    <steps>
      <step>Confirm docs/reverse-engineering/04-architecture/ directory exists</step>
      <step>Verify C4-L1-SYSTEM-CONTEXT.md exists and is non-empty</step>
      <step>Verify C4-L2-CONTAINER.md exists and is non-empty</step>
      <step>Verify C4-L3-COMPONENT.md exists and is non-empty</step>
      <step>Verify C4-L4-CODE-PATTERNS.md exists and is non-empty</step>
      <step>Check for diagrams/ subdirectory and its contents</step>
      <step>Verify program count stated in documentation equals 31 (NOT 39)</step>
      <step>Verify BMS mapset count stated in documentation equals 17 (NOT 21)</step>
      <step>Verify copybook count stated in documentation equals 30</step>
      <step>Verify extension directory count stated in documentation equals 3</step>
    </steps>
  </phase>

  <phase name="Phase 2: L1 System Context Validation">
    <description>Validate Level 1 system context diagram and descriptions</description>
    <steps>
      <step>Read C4-L1-SYSTEM-CONTEXT.md and extract all actor definitions</step>
      <step>Verify 4 actor types are present: Card Holder, Customer Service Rep, System Administrator, Batch Operator</step>
      <step>Verify external systems are identified: Card Network, Core Banking, Statement Printing</step>
      <step>Confirm external systems are marked as optional where appropriate</step>
      <step>Verify CardDemo is depicted as a single system at L1 (not decomposed)</step>
      <step>Check actor-to-system relationships are described with correct interactions</step>
      <step>Validate Mermaid C4Context diagram syntax if present</step>
      <step>Cross-reference actor types against COSGN00C.cbl sign-on logic to verify user type claims</step>
      <step>Cross-reference external system claims against extension directory contents</step>
    </steps>
  </phase>

  <phase name="Phase 3: L2 Container Validation">
    <description>Validate Level 2 container diagram and descriptions</description>
    <steps>
      <step>Read C4-L2-CONTAINER.md and extract all container definitions</step>
      <step>Verify CICS Online Region container is documented with correct technology (CICS TS)</step>
      <step>Verify Batch Subsystem container is documented with correct technology (JES2/JCL)</step>
      <step>Verify VSAM Data Store container lists all 6 KSDS files: ACCTDAT, CARDDAT, CUSTDAT, TRANSACT, CCXREF, USRSEC</step>
      <step>Verify BMS Presentation container states 17 mapsets (NOT 21)</step>
      <step>Verify optional containers (DB2, IMS, MQ) are marked as optional and linked to correct extension directories</step>
      <step>Verify container-to-container relationships: CICS-to-VSAM (EXEC CICS FILE), Batch-to-VSAM (COBOL I/O), CICS-to-BMS (SEND MAP)</step>
      <step>Validate Mermaid C4Container diagram syntax if present</step>
      <step>Confirm no implementation details leak into L2 (programs belong at L3)</step>
    </steps>
  </phase>

  <phase name="Phase 4: L3 Component Validation">
    <description>Validate Level 3 component diagrams and program classifications</description>
    <steps>
      <step>Read C4-L3-COMPONENT.md and extract all component/program listings</step>
      <step>For each listed program, verify it exists in app/cbl/ using exact filename including extension case</step>
      <step>Flag any program listed in documentation that does NOT exist in app/cbl/</step>
      <step>Flag any program in app/cbl/ that is NOT listed in documentation (completeness gap)</step>
      <step>Verify 19 online programs are assigned to CICS Online Region container</step>
      <step>Verify 12 batch programs are assigned to Batch Subsystem container</step>
      <step>Verify functional groupings are logical: Authentication, Navigation, Account Mgmt, Card Mgmt, Transaction, Bill Payment, User Admin, Batch Account, Batch Transaction, Batch Customer, Utilities, Export/Import</step>
      <step>Verify COBSWAIT.cbl and CSUTLDTC.cbl are included and correctly classified</step>
      <step>Verify CBSTM03A.CBL and CBSTM03B.CBL are included (note uppercase .CBL extension)</step>
      <step>Verify CBEXPORT.cbl and CBIMPORT.cbl are included in batch components</step>
      <step>Verify CORPT00C.cbl is included in online components</step>
      <step>Check component interaction types: XCTL, LINK, COMMAREA are documented</step>
      <step>Validate Mermaid C4Component diagram syntax if present</step>
    </steps>
  </phase>

  <phase name="Phase 5: L4 Code Pattern Validation">
    <description>Validate Level 4 code patterns and algorithm documentation</description>
    <steps>
      <step>Read C4-L4-CODE-PATTERNS.md and extract all documented patterns</step>
      <step>Verify at least 7 architectural patterns are documented</step>
      <step>For each pattern with a code excerpt, read the cited source file at the cited line number</step>
      <step>Compare the quoted code excerpt against the actual source — flag any mismatches</step>
      <step>Verify pseudo-conversational pattern: EIBCALEN check exists in cited CO* program</step>
      <step>Verify VSAM CRUD pattern: READ/WRITE/REWRITE/DELETE operations exist in cited program</step>
      <step>Verify screen-program coupling: SEND MAP/RECEIVE MAP exists in cited program</step>
      <step>Verify error handling pattern: RESP/RESP2 checking exists in cited program</step>
      <step>Verify batch sequential processing: OPEN/READ/WRITE/CLOSE pattern exists in cited CB* program</step>
      <step>Check algorithm documentation (interest calculation in CBTRN02C, payment validation in COBIL00C)</step>
      <step>Verify no PIC clause hallucinations (e.g., S9(7)V99 instead of actual S9(10)V99)</step>
      <step>Confirm code examples are from the correct programs and show real patterns</step>
    </steps>
  </phase>

  <phase name="Phase 6: Cross-Level Consistency and Diagram Validation">
    <description>Validate consistency across all four C4 levels and diagram correctness</description>
    <steps>
      <step>Verify L1 system is decomposed into L2 containers (not skipping levels)</step>
      <step>Verify every L2 container is decomposed into L3 components</step>
      <step>Verify L3 component programs have L4 code pattern coverage</step>
      <step>Verify naming consistency across levels (same program names, same container names)</step>
      <step>Verify all Mermaid diagrams use valid C4 syntax (C4Context, C4Container, C4Component)</step>
      <step>Verify diagrams render without syntax errors (balanced braces, valid element types)</step>
      <step>Verify diagram relationships match textual descriptions</step>
      <step>Check for orphaned components (listed at one level but missing at another)</step>
      <step>Verify extension directories are consistently described across all levels</step>
      <step>Confirm the documentation follows AS-IS architecture principle (no TO-BE prescriptions)</step>
    </steps>
  </phase>
</validation_methodology>

<scoring_rubric>
  <category name="Source Reference Accuracy" weight="35" severity="Critical">
    <description>Every file:line citation verified against actual source code</description>
    <checks>
      <check>Code pattern excerpts match actual source at cited locations</check>
      <check>Program filenames match exactly (including case of .cbl vs .CBL)</check>
      <check>PIC clauses quoted in patterns match actual copybook definitions</check>
      <check>CICS command syntax in examples matches actual program code</check>
      <check>No fabricated code excerpts or line references</check>
    </checks>
    <scoring>
      <score value="100">All source references verified correct</score>
      <score value="80">1-2 minor source reference errors</score>
      <score value="60">3-5 source reference errors or 1 fabricated excerpt</score>
      <score value="40">Multiple fabricated code excerpts</score>
      <score value="0">Majority of source references are incorrect or fabricated</score>
    </scoring>
  </category>

  <category name="Factual Accuracy" weight="25" severity="Critical">
    <description>Program functions, container mappings, relationships, and pattern descriptions match reality</description>
    <checks>
      <check>Programs assigned to correct containers (online vs batch)</check>
      <check>Functional groupings accurately reflect program purposes</check>
      <check>Container technology descriptions are correct (CICS TS, JES2, VSAM KSDS)</check>
      <check>VSAM file names and key structures are correct</check>
      <check>Inter-program communication types (XCTL, LINK, COMMAREA) accurately described</check>
      <check>Optional extensions correctly linked to extension directories</check>
      <check>Actor types and roles match application behavior</check>
    </checks>
    <scoring>
      <score value="100">All factual claims verified correct</score>
      <score value="80">1-3 minor factual inaccuracies</score>
      <score value="60">4-6 factual errors or 1 critical misclassification</score>
      <score value="40">Multiple critical factual errors</score>
      <score value="0">Pervasive factual inaccuracies</score>
    </scoring>
  </category>

  <category name="Completeness" weight="20" severity="Major">
    <description>All expected programs, containers, patterns, and relationships documented</description>
    <checks>
      <check>All 31 programs listed and classified</check>
      <check>All 6 VSAM files documented</check>
      <check>All 17 BMS mapsets accounted for</check>
      <check>All 3 extension directories described</check>
      <check>All 4 C4 levels documented with appropriate detail</check>
      <check>7+ architectural patterns documented</check>
      <check>Component interactions documented (XCTL, LINK, COMMAREA)</check>
      <check>Key algorithms documented (interest calculation, payment validation)</check>
    </checks>
    <scoring>
      <score value="100">All expected items documented</score>
      <score value="80">90%+ coverage with minor gaps</score>
      <score value="60">75-89% coverage</score>
      <score value="40">50-74% coverage</score>
      <score value="0">Less than 50% coverage</score>
    </scoring>
  </category>

  <category name="Quantitative Accuracy" weight="10" severity="Major">
    <description>File counts, record lengths, and numeric claims are correct</description>
    <checks>
      <check>Program count is 31 (NOT 39)</check>
      <check>BMS mapset count is 17 (NOT 21)</check>
      <check>Copybook count is 30</check>
      <check>BMS copybook count is 17</check>
      <check>JCL file count is 38</check>
      <check>Extension directory count is 3</check>
      <check>VSAM file count is 6</check>
      <check>Online program count is 19</check>
      <check>Batch program count is 12</check>
      <check>Architectural pattern count is 7+</check>
    </checks>
    <scoring>
      <score value="100">All counts exactly correct</score>
      <score value="80">1 count off by 1-2</score>
      <score value="60">2-3 counts incorrect</score>
      <score value="40">Major count errors (e.g., 39 instead of 31)</score>
      <score value="0">Multiple major count errors</score>
    </scoring>
  </category>

  <category name="Documentation Quality" weight="10" severity="Minor">
    <description>Mermaid diagram syntax, markdown formatting, clarity of descriptions</description>
    <checks>
      <check>Mermaid C4 diagrams use valid syntax and would render correctly</check>
      <check>Markdown headings, tables, and code blocks are well-formed</check>
      <check>C4 level boundaries respected (no implementation details at wrong level)</check>
      <check>Descriptions are clear and unambiguous</check>
      <check>Consistent terminology across all four documents</check>
      <check>Optional components clearly distinguished from core components</check>
    </checks>
    <scoring>
      <score value="100">Excellent quality, all diagrams valid, clear writing</score>
      <score value="80">Minor formatting issues, diagrams mostly valid</score>
      <score value="60">Several formatting issues or 1-2 broken diagrams</score>
      <score value="40">Multiple broken diagrams, unclear descriptions</score>
      <score value="0">Documentation is poorly structured and diagrams are broken</score>
    </scoring>
  </category>

  <verdict_thresholds>
    <threshold min="100" max="100" verdict="PASS" meaning="Documentation is reliable for downstream use"/>
    <threshold min="0" max="99" verdict="FAIL" meaning="Documentation is unreliable and must be regenerated"/>
  </verdict_thresholds>

  <finding_severity_levels>
    <level name="Critical">Hallucinated programs, fabricated code excerpts, wrong program counts, incorrect container mappings — causes incorrect modernization decisions</level>
    <level name="Major">Missing programs in component inventory, incomplete pattern coverage, missing VSAM files — causes gaps in modernization planning</level>
    <level name="Minor">Broken Mermaid syntax, formatting issues, unclear descriptions, inconsistent terminology — causes friction but not errors</level>
  </finding_severity_levels>
</scoring_rubric>

<foundational_principles>
  <principle id="1">Every program listed in the C4 documentation must exist as a real file in app/cbl/ — no hallucinated programs</principle>
  <principle id="2">The correct program count is 31 (19 online + 12 batch), NOT 39 — the RE-004 prompt itself contains this error in its success criteria</principle>
  <principle id="3">The correct BMS mapset count is 17, NOT 21 — this error propagates from CLAUDE.md into RE-004's container descriptions</principle>
  <principle id="4">Code pattern excerpts must be verifiable by reading the actual source file at the cited line — fabricated code is a critical finding</principle>
  <principle id="5">C4 levels must maintain correct abstraction: L1 shows the system as a black box, L2 shows containers, L3 shows components within containers, L4 shows code patterns within components</principle>
  <principle id="6">Container classifications must be accurate: CICS Online Region hosts CO*/CS* programs, Batch Subsystem hosts CB* programs — cross-container misclassification is a critical error</principle>
  <principle id="7">Extension directories (app-authorization-ims-db2-mq, app-transaction-type-db2, app-vsam-mq) represent optional integration capabilities and must be clearly marked as optional at every C4 level where they appear</principle>
  <principle id="8">The architecture documentation must describe what exists (AS-IS) without prescribing what should exist (TO-BE) — modernization recommendations belong in RE-010/RE-011, not in C4 architecture</principle>
</foundational_principles>

<critical_reminders>
  <reminder id="1">The RE-004 prompt itself claims 39 programs and 21 BMS mapsets — the generated documentation may inherit these errors. Flag them as Critical findings every time.</reminder>
  <reminder id="2">CBSTM03A.CBL and CBSTM03B.CBL have uppercase .CBL extensions — verify the documentation does not omit them due to case-sensitivity assumptions.</reminder>
  <reminder id="3">COSTM01.CPY has an uppercase .CPY extension — verify it is not missed in copybook inventories.</reminder>
  <reminder id="4">CSUTLDTC.cbl is a utility program that does not follow the CO*/CB* naming convention — verify it is included and correctly classified.</reminder>
  <reminder id="5">COBSWAIT.cbl is an online program despite its name suggesting batch — verify its container assignment is correct.</reminder>
  <reminder id="6">CORPT00C.cbl is an online report generation program — verify it is assigned to the CICS Online Region, not the Batch Subsystem.</reminder>
  <reminder id="7">VSAM access patterns differ between online (EXEC CICS FILE) and batch (standard COBOL I/O verbs) — verify the documentation correctly distinguishes these.</reminder>
  <reminder id="8">Known hallucination: CVCAR00Y.cpy does not exist. The actual card copybook is CVCRD01Y.cpy. Flag any reference to CVCAR00Y as Critical.</reminder>
  <reminder id="9">Known hallucination: COUSR00Y.cpy does not exist. The actual user security copybook is CSUSR01Y.cpy. Flag any reference to COUSR00Y as Critical.</reminder>
  <reminder id="10">Known hallucination: S9(7)V99 is not the correct PIC clause for monetary fields. The actual PIC is S9(10)V99 in CVACT01Y.cpy. Flag any reference to S9(7)V99 as Critical.</reminder>
</critical_reminders>

<context_compaction_survival>
  <work_tracking_directory>
    <path>.work/reverse-engineering/validation/vl-004/</path>
    <purpose>Persist validation progress to survive context window compaction</purpose>
  </work_tracking_directory>

  <progress_tracking_schema>
    <file>progress.yaml</file>
    <structure>
```yaml
validation_phase: "inventory|l1_context|l2_container|l3_component|l4_code|cross_level|scoring|report"
current_phase: 1-6
phases_completed: [1, 2, ...]
current_analysis:
  target_file: "filename being validated"
  checks_completed: []
  findings: []
programs_verified:
  exist: []
  missing: []
  hallucinated: []
patterns_verified:
  verified: []
  fabricated: []
  unverified: []
counts_checked:
  programs: { claimed: null, actual: 31 }
  bms: { claimed: null, actual: 17 }
  copybooks: { claimed: null, actual: 30 }
  jcl: { claimed: null, actual: 38 }
  extensions: { claimed: null, actual: 3 }
score_tracking:
  source_reference_accuracy: null
  factual_accuracy: null
  completeness: null
  quantitative_accuracy: null
  documentation_quality: null
  total: null
artifacts_created:
  - path: "relative path"
    type: "checklist|findings|report"
    status: "complete|partial"
next_action: "Detailed next step"
last_updated: "ISO timestamp"
```
    </structure>
  </progress_tracking_schema>

  <resumption_protocol>
    <step>1. Read .work/reverse-engineering/validation/vl-004/progress.yaml</step>
    <step>2. Load any completed phase artifacts (findings lists, checklists)</step>
    <step>3. Resume from current_phase and next_action</step>
    <step>4. Update progress after each phase completion</step>
    <step>5. Generate final report only after all 6 phases complete</step>
  </resumption_protocol>
</context_compaction_survival>

<begin>
  <instruction>
    Check for existing progress:
    1. Read .work/reverse-engineering/validation/vl-004/progress.yaml if it exists
    2. If progress exists:
       - Load completed phase artifacts and findings
       - Resume from current_phase
    3. If starting fresh:
       - Verify docs/reverse-engineering/04-architecture/ exists with expected files
       - Begin with Phase 1: File Existence and Inventory Verification
       - Create progress.yaml in .work/reverse-engineering/validation/vl-004/
    4. Execute validation phases sequentially:
       - Phase 1: File Existence and Inventory Verification
       - Phase 2: L1 System Context Validation
       - Phase 3: L2 Container Validation
       - Phase 4: L3 Component Validation
       - Phase 5: L4 Code Pattern Validation
       - Phase 6: Cross-Level Consistency and Diagram Validation
    5. After each phase:
       - Record findings with severity levels
       - Update progress.yaml
    6. After all phases complete:
       - Calculate weighted scores using the scoring rubric (35/25/20/10/10)
       - Determine verdict (PASS (100), FAIL (less than 100))
       - Generate the validation report

    CRITICAL VALIDATION RULES:
    - For every program listed in L3 documentation, run: ls app/cbl/{PROGRAM_NAME} to confirm existence
    - For every code excerpt in L4, read the cited source file and verify the excerpt matches
    - Check EVERY numeric count (programs, BMS, copybooks, JCL, extensions) against ground truth
    - Actively search for known hallucinations: CVCAR00Y.cpy, COUSR00Y.cpy, S9(7)V99, count of 39, count of 21
    - Verify ALL Mermaid diagram syntax for valid C4 elements
    - Flag any TO-BE architecture recommendations as out-of-scope findings
  </instruction>
</begin>
```

## Usage

Execute this prompt with Claude Code to validate the C4 architecture documentation generated by RE-004. The prompt will systematically verify all four C4 levels against the actual CardDemo source code, checking program inventories, container mappings, code pattern excerpts, diagram syntax, and cross-level consistency.

```bash
# Run validation after RE-004 output exists
claude "Execute the VL-004 validation prompt" \
  --file prompts/reverse-engineering/validation/VL-004-c4-architecture-validation.md
```

## Expected Output

The validation produces a single report file:

| File | Description |
|------|-------------|
| `docs/reverse-engineering/validation/VL-004-c4-architecture-report.md` | Complete validation report with verdict, scores, findings, and recommendations |

### Report Structure

```markdown
# Validation Report: C4 Architecture (RE-004)

## Verdict: [PASS|FAIL] — Score: [NN]/100

## Score Breakdown
| Category | Weight | Score | Weighted |
|----------|--------|-------|----------|
| Source Reference Accuracy | 35% | NN/100 | NN.N |
| Factual Accuracy | 25% | NN/100 | NN.N |
| Completeness | 20% | NN/100 | NN.N |
| Quantitative Accuracy | 10% | NN/100 | NN.N |
| Documentation Quality | 10% | NN/100 | NN.N |
| **Total** | **100%** | | **NN.N** |

## Critical Findings
## Major Findings
## Minor Findings
## Hallucination Inventory
## Completeness Gaps
## Recommendations

## Remediation Manifest
| ID | Finding | Target File | Location | Current (Wrong) | Required (Correct) | Source Evidence | Remediation Action | RE Prompt |
|----|---------|-------------|----------|-----------------|--------------------|-----------------|--------------------|-----------|
| R-001 | [finding] | [doc path] | [section/line] | [wrong] | [correct] | [source:line] | [fix] | [RE-NNN] |
### Remediation Instructions
For each row: (1) Read target at location, (2) Verify wrong value, (3) Replace with correct, (4) Re-validate
### Affected RE Prompts
[List RE prompts needing re-execution]
```

## Prerequisites

- RE-004 (C4 Architecture) must have been executed and its output must exist in `docs/reverse-engineering/04-architecture/`
- Expected files: `C4-L1-SYSTEM-CONTEXT.md`, `C4-L2-CONTAINER.md`, `C4-L3-COMPONENT.md`, `C4-L4-CODE-PATTERNS.md`
- Optional: `diagrams/` subdirectory with Mermaid diagram files
- Access to source code in `app/cbl/`, `app/cpy/`, `app/bms/`, `app/jcl/`, and `app/app-*/`

## Depends On

- **VL-003** (Context Model Validation) — Phase 3 in the validation execution order. VL-003 validates the bounded contexts that inform L3 component groupings.

## Blocks

- **VL-010** (Modernization Readiness Validation) — requires validated architecture as baseline for complexity assessment
- **VL-011** (API Candidates Validation) — requires validated component inventory for API mapping
- **VL-000** (Cross-Document Consistency) — requires all individual validations to complete before cross-document checks
